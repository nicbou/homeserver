version: "3.5"
services:
  db:
    image: postgres:14
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_DB=homeserver
      - POSTGRES_PASSWORD=postgres
    volumes:
      - db_persistence:/var/lib/postgresql/data
    restart: unless-stopped
  backend:
    build: backend
    depends_on:
      - db
      - videoprocessing
    environment:
      - BACKEND_DEBUG
      - BACKEND_SECRET_KEY
      - POSTGRES_HOST=db
      - POSTGRES_USER=postgres
      - POSTGRES_DB=homeserver
      - POSTGRES_PASSWORD=postgres
      - MOVIE_LIBRARY_PATH=/var/www/movies/library
      - MOVIE_LIBRARY_URL=/movies
      - TRIAGE_PATH=/movies/triage
      - VIDEO_PROCESSING_API_URL=http://videoprocessing
    volumes:
      - django_staticfiles:/srv/static
      - ./backend/src:/srv/src
      - ${MOVIE_LIBRARY_PATH}:/movies
    restart: unless-stopped
  redis:
    image: redis:7-alpine
    volumes:
      - redis_persistence:/data
    restart: unless-stopped
  videoprocessing:
    build: videoprocessing
    environment:
      - MOVIE_LIBRARY_PATH=/var/www/movies/library
      - REDIS_DB_URL=redis://redis:6379/1
      - MAX_VIDEO_BITRATE
      - DEFAULT_VIDEO_HEIGHT
    volumes:
      - ${MOVIE_LIBRARY_PATH}:/movies
    depends_on:
      - redis
    restart: unless-stopped
  torrents:
    image: haugene/transmission-openvpn:latest
    environment:
      - OPENVPN_PROVIDER
      - OPENVPN_USERNAME
      - OPENVPN_PASSWORD
      - OPENVPN_CONFIG=netherlands
      - TRANSMISSION_DOWNLOAD_DIR=/triage
      - TRANSMISSION_SPEED_LIMIT_UP=250
      - TRANSMISSION_SPEED_LIMIT_UP_ENABLED=true
      - TRANSMISSION_RPC_HOST_WHITELIST_ENABLED=false
      - PIA_OPENVPN_CONFIG_BUNDLE=openvpn
      - LOCAL_NETWORK=192.168.0.0/16
    volumes:
      - ${TRANSMISSION_DATA_PATH}:/data
      - ${MOVIE_LIBRARY_PATH}/triage:/triage
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
    restart: unless-stopped
  timeline:
    build: timeline
    environment:
      - "GOOGLE_MAPS_API_KEY"
    volumes:
      - ${TIMELINE_DATA_PATH}:/media/timeline
      - timeline_persistence:/var/timeline/output
  proxy:
    build:
      context: ./proxy
    environment:
      - SSL_DOMAIN
      - SSL_EMAIL
    volumes:
      - "./frontend/src:/var/www/movies/frontend:ro"
      - "timeline_persistence:/var/www/timeline:ro"
      - "django_staticfiles:/var/www/movies/django-static:ro"
      - "${MOVIE_LIBRARY_PATH}/library:/var/www/movies/library:ro"
      - "caddy_data:/data"
      - "caddy_config:/config"
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    depends_on:
      - backend
      - videoprocessing
      - torrents
  dynamicdns:
    build: dynamicdns
    environment:
      - DIGITALOCEAN_TOKEN
      - DOMAIN=nicolasbouliane.com
      - "SUBDOMAINS=home,timeline"
volumes:
  caddy_data:
  caddy_config:
  django_staticfiles:
  db_persistence:
  redis_persistence:
  timeline_persistence:
networks:
  default:
    name: homeserver
