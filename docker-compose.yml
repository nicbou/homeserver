version: "3.5"
services:
  db:
    image: postgres:9.6
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - db_persistence:/var/lib/postgresql/data
    userns_mode: "host"
  backend:
    build: backend
    depends_on:
      - db
      - videoprocessing
    environment:
      - BACKEND_DEBUG
      - BACKEND_SECRET_KEY
      - MOVIE_LIBRARY_PATH=/movies/library
      - MOVIE_LIBRARY_URL=/movies
      - TRIAGE_PATH=/movies/triage
      - VIDEO_PROCESSING_API_URL=http://videoprocessing
    volumes:
      - django_staticfiles:/srv/static
      - ./backend/src:/srv/src
      - ${MOVIE_LIBRARY_PATH}:/movies
    privileged: true
    userns_mode: "host"
  frontend:
    image: nginx
    volumes:
      - ./frontend/src:/usr/share/nginx/html:ro
    depends_on:
      - backend
      - torrents
  redis:
    image: smebberson/alpine-redis
    volumes:
      - redis_persistence:/data
  videoprocessing:
    build: videoprocessing
    environment:
      - MOVIE_LIBRARY_PATH=/movies/library
      - REDIS_DB_URL=redis://redis:6379/1
    volumes:
      - ${MOVIE_LIBRARY_PATH}:/movies
    ports:
      - "9181:9181"
    depends_on:
      - redis
    privileged: true
    userns_mode: "host"
  torrents:
    image: haugene/transmission-openvpn:latest
    privileged: true
    environment:
      - OPENVPN_PROVIDER
      - OPENVPN_USERNAME
      - OPENVPN_PASSWORD
      - TRANSMISSION_DOWNLOAD_DIR=/triage
      - TRANSMISSION_SPEED_LIMIT_UP=250
      - TRANSMISSION_SPEED_LIMIT_UP_ENABLED=true
      - TRANSMISSION_RPC_HOST_WHITELIST_ENABLED=false
      - PIA_OPENVPN_CONFIG_BUNDLE=openvpn
      - OPENVPN_CONFIG=netherlands
      - OPENVPN_OPTS=--inactive 3600 --ping 10 --ping-exit 60
      - LOCAL_NETWORK=192.168.0.0/24
    volumes:
      - ${TRANSMISSION_DATA_PATH}:/data
      - ${MOVIE_LIBRARY_PATH}/triage:/triage
    restart: on-failure
    dns:
      - 8.8.8.8
      - 8.8.4.4
    cap_add:
      - ALL
    userns_mode: "host"
  pihole:
    image: pihole/pihole:latest
    hostname: pihole
    environment:
      - DNS1=1.1.1.1
      - DNS2=1.0.0.1
      - VIRTUAL_HOST=pihole
    ports:
      - '53:53/tcp'
      - '53:53/udp'
    restart: unless-stopped
    volumes:
      - pihole_persistence:/etc/pihole
      - pihole_config:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
  nextcloud-php:
    image: nextcloud:fpm
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_USER=postgres
      - POSTGRES_DB=nextcloud
      - POSTGRES_PASSWORD=postgres
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=home.nicolasbouliane.com
      - OVERWRITEWEBROOT=/cloud
      - NEXTCLOUD_DATA_DIR=/opt/nextcloud/files
    volumes:
      - "nextcloud:/var/www/html"
      - "${NEXTCLOUD_FILES_PATH}:/opt/nextcloud/files"
    restart: always
  nextcloud-nginx:
    build: nextcloud-nginx
    volumes:
      - "nextcloud:/var/www/html:ro"
      - "${NEXTCLOUD_FILES_PATH}:/opt/nextcloud/files:ro"
    depends_on:
      - nextcloud-php
    restart: always
  proxy:
    build: proxy
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - frontend
      - backend
      - videoprocessing
      - torrents
      - pihole
      - nextcloud-php
    volumes:
      - django_staticfiles:/static:ro
      - ${MOVIE_LIBRARY_PATH}:/movies:ro
      - "./proxy/ssl-certs:/etc/ssl/certs"
      - "nextcloud:/var/www/html"
  dynamicdns:
    image: tunix/digitalocean-dyndns
    environment:
      - DIGITALOCEAN_TOKEN
      - DOMAIN=nicolasbouliane.com
      - NAME=home
volumes:
  django_staticfiles:
  db_persistence:
  redis_persistence:
  pihole_persistence:
  pihole_config:
  nextcloud:
networks:
  default:
    name: homeserver
